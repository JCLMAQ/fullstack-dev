<div class="image-gallery">
  <!-- Header avec actions globales -->
  <div class="border-b border-gray-200 pb-6 mb-6" *ngIf="showActions()">
    <div class="flex flex-wrap justify-between items-center gap-4">
      <div class="flex flex-wrap gap-3">
        <button
          type="button"
          (click)="selectAll()"
          class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200"
        >
          <mat-icon class="mr-2">select_all</mat-icon>
          {{ 'IMAGE_GALLERY.SELECT_ALL' | translate }}
        </button>

        <button
          type="button"
          (click)="clearSelection()"
          [disabled]="selectedImages().length === 0"
          class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
        >
          <mat-icon class="mr-2">clear</mat-icon>
          {{ 'IMAGE_GALLERY.CLEAR_SELECTION' | translate }}
        </button>

        <button
          type="button"
          (click)="deleteSelected()"
          [disabled]="selectedImages().length === 0"
          class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
        >
          <mat-icon class="mr-2">delete</mat-icon>
          {{ 'IMAGE_GALLERY.DELETE_SELECTED' | translate }} ({{ selectedImages().length }})
        </button>
      </div>

      <div class="text-sm text-gray-600">
        <span class="font-medium">{{ images().length }}</span> {{ 'IMAGE_GALLERY.IMAGES_TOTAL' | translate }}
        <span *ngIf="selectedImages().length > 0" class="ml-2 text-blue-600 font-medium">
          - {{ selectedImages().length }} {{ 'IMAGE_GALLERY.SELECTED' | translate }}
        </span>
      </div>
    </div>
  </div>

  <!-- Chargement -->
  <div class="flex flex-col items-center justify-center py-12" *ngIf="loading()">
    <mat-progress-spinner diameter="50" class="mb-4"></mat-progress-spinner>
    <p class="text-gray-600">{{ 'IMAGE_GALLERY.LOADING' | translate }}</p>
  </div>

  <!-- Galerie d'images -->
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6" *ngIf="!loading() && images().length > 0">
    <div
      *ngFor="let image of images(); trackBy: trackByImageId"
      [class.ring-2]="isSelected(image.id)"
      [class.ring-blue-500]="isSelected(image.id)"
      class="relative bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200 cursor-pointer overflow-hidden"
      (click)="onImageClick(image)"
      (keyup.enter)="onImageClick(image)"
      (keyup.space)="onImageClick(image)"
      tabindex="0"
      [attr.aria-label]="'Select image: ' + image.originalName"
    >
      <!-- Checkbox de sélection -->
      <div class="absolute top-2 left-2 z-10" *ngIf="selectionMode()">
        <div class="bg-white rounded-full p-1 shadow-md">
          <mat-icon [class]="isSelected(image.id) ? 'text-blue-600' : 'text-gray-400'">
            {{ isSelected(image.id) ? 'check_circle' : 'radio_button_unchecked' }}
          </mat-icon>
        </div>
      </div>

      <!-- Image -->
      <div class="aspect-square">
        <img
          [src]="image.thumbnailUrl || image.storageUrl || '/assets/images/placeholder.png'"
          [alt]="image.altText || image.originalName"
          class="w-full h-full object-cover"
          (error)="onImageError($event)"
          loading="lazy"
        />

        <!-- Overlay avec actions -->
        <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-50 transition-all duration-200 flex items-center justify-center opacity-0 hover:opacity-100">
          <div class="flex gap-2">
            <button
              type="button"
              (click)="viewImage(image, $event)"
              class="p-2 bg-white rounded-full shadow-md hover:bg-gray-50 transition-colors duration-200"
              [attr.aria-label]="'IMAGE_GALLERY.VIEW' | translate"
            >
              <mat-icon class="text-gray-700">visibility</mat-icon>
            </button>

            <button
              type="button"
              [matMenuTriggerFor]="imageMenu"
              (click)="$event.stopPropagation()"
              class="p-2 bg-white rounded-full shadow-md hover:bg-gray-50 transition-colors duration-200"
              [attr.aria-label]="'IMAGE_GALLERY.MORE_ACTIONS' | translate"
            >
              <mat-icon class="text-gray-700">more_vert</mat-icon>
            </button>

            <!-- Menu d'actions -->
            <mat-menu #imageMenu="matMenu">
              <button mat-menu-item (click)="editImage()">
                <mat-icon>edit</mat-icon>
                <span>{{ 'IMAGE_GALLERY.EDIT' | translate }}</span>
              </button>
              <button mat-menu-item (click)="downloadImage(image)">
                <mat-icon>download</mat-icon>
                <span>{{ 'IMAGE_GALLERY.DOWNLOAD' | translate }}</span>
              </button>
              <button mat-menu-item (click)="copyImageUrl(image)">
                <mat-icon>link</mat-icon>
                <span>{{ 'IMAGE_GALLERY.COPY_URL' | translate }}</span>
              </button>
              <mat-divider></mat-divider>
              <button mat-menu-item (click)="deleteImage(image)" class="text-red-600">
                <mat-icon class="text-red-600">delete</mat-icon>
                <span>{{ 'IMAGE_GALLERY.DELETE' | translate }}</span>
              </button>
            </mat-menu>
          </div>
        </div>
      </div>

      <!-- Informations de l'image -->
      <div class="p-4">
        <h3 class="text-sm font-medium text-gray-900 truncate mb-1">
          {{ image.originalName }}
        </h3>
        <div class="flex justify-between items-center text-xs text-gray-500">
          <span>{{ formatFileSize(image.fileSize) }}</span>
          <span *ngIf="image.width && image.height">
            {{ image.width }}×{{ image.height }}
          </span>
        </div>

        <!-- Tags -->
        <div class="mt-2" *ngIf="image.tags && image.tags.length > 0">
          <div class="flex flex-wrap gap-1">
            <span
              *ngFor="let tag of image.tags.slice(0, 2)"
              class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
            >
              {{ tag }}
            </span>
            <span
              *ngIf="image.tags.length > 2"
              class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800"
            >
              +{{ image.tags.length - 2 }}
            </span>
          </div>
        </div>

        <!-- Statut de publication -->
        <div class="mt-2 flex justify-end">
          <mat-icon
            [class]="image.isPublic ? 'text-green-600' : 'text-gray-400'"
            [matTooltip]="image.isPublic ? ('IMAGE_GALLERY.PUBLIC' | translate) : ('IMAGE_GALLERY.PRIVATE' | translate)"
            class="text-sm"
          >
            {{ image.isPublic ? 'public' : 'lock' }}
          </mat-icon>
        </div>
      </div>
    </div>
  </div>

  <!-- Message si aucune image -->
  <div class="text-center py-12" *ngIf="!loading() && images().length === 0">
    <mat-icon class="text-6xl text-gray-400 mb-4">image</mat-icon>
    <h3 class="text-lg font-medium text-gray-900 mb-2">
      {{ 'IMAGE_GALLERY.NO_IMAGES' | translate }}
    </h3>
    <p class="text-gray-600">
      {{ 'IMAGE_GALLERY.NO_IMAGES_DESCRIPTION' | translate }}
    </p>
  </div>
</div>
