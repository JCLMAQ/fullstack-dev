<div class="user-detail-container">
  <!-- Loading Spinner -->
  @if (isLoading()) {
    <div class="loading-spinner">
      <mat-spinner></mat-spinner>
    </div>
  }

  @if (!isLoading()) {
    <!-- Toolbar Header -->
    <mat-toolbar color="primary">
      <button mat-icon-button (click)="goBack()" matTooltip="Back to list">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <span class="toolbar-title">User Detail</span>
      <span class="spacer"></span>
      @if (selectedUsers().length > 0) {
        <span class="navigation-info">
          {{ currentIndex() + 1 }} / {{ selectedUsers().length }}
        </span>
      }
      @if (mode() === 'view') {
        <button mat-icon-button matTooltip="Edit" (click)="mode.set('edit')">
          <mat-icon>edit</mat-icon>
        </button>
      }
    </mat-toolbar>

    <!-- Main Content -->
    <div class="content">
      <mat-card class="form-card">
        <mat-card-header>
          <mat-card-title>
            @if (mode() === 'view') {
              {{ userForm().value().firstName }} {{ userForm().value().lastName }}
            } @else {
              Ajouter / Modifier un utilisateur
            }
          </mat-card-title>
        </mat-card-header>

        <mat-card-content>
          <form>
            <div class="form-grid">
              <!-- Section: Informations de base -->
              <h3 class="section-title">Informations de base</h3>

              <!-- ID (readonly) -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>ID</mat-label>
                <input matInput [value]="userForm().value().id" readonly />
              </mat-form-field>

              <!-- Email -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Email</mat-label>
                @if (mode() === 'view') {
                  <input
                    matInput
                    [value]="userForm().value().email"
                    type="email"
                    readonly
                  />
                } @else {
                  <input
                    matInput
                    [field]="userForm.email"
                    type="email"
                    placeholder="Enter email"
                  />
                  <lib-field-error [fieldError]="userForm.email()" />
                }
              </mat-form-field>

              <!-- First Name -->
              <mat-form-field appearance="outline">
                <mat-label>First Name</mat-label>
                @if (mode() === 'view') {
                  <input
                    matInput
                    [value]="userForm().value().firstName"
                    readonly
                  />
                } @else {
                  <input
                    matInput
                    [field]="userForm.firstName"
                    placeholder="Enter first name"
                  />
                  <lib-field-error [fieldError]="userForm.firstName()" />
                }
              </mat-form-field>

              <!-- Last Name -->
              <mat-form-field appearance="outline">
                <mat-label>Last Name</mat-label>
                @if (mode() === 'view') {
                  <input
                    matInput
                    [value]="userForm().value().lastName"
                    readonly
                  />
                } @else {
                  <input
                    matInput
                    [field]="userForm.lastName"
                    placeholder="Enter last name"
                  />
                  <lib-field-error [fieldError]="userForm.lastName()" />
                }
              </mat-form-field>

              <!-- Title -->
              <mat-form-field appearance="outline">
                <mat-label>Title</mat-label>
                @if (mode() === 'view') {
                  <input matInput [value]="userForm().value().title ?? ''" readonly />
                } @else {
                  <mat-select [field]="userForm.title">
                    <mat-option [value]="null">None</mat-option>
                    @for (title of titleOptions; track title) {
                      <mat-option [value]="title">{{ title }}</mat-option>
                    }
                  </mat-select>
                }
              </mat-form-field>

              <!-- Nick Name -->
              <mat-form-field appearance="outline">
                <mat-label>Nick Name</mat-label>
                @if (mode() === 'view') {
                  <input
                    matInput
                    [value]="userForm().value().nickName"
                    readonly
                  />
                } @else {
                  <input
                    matInput
                    [field]="userForm.nickName"
                    placeholder="Enter nick name"
                  />
                }
              </mat-form-field>

              <!-- Gender -->
              <mat-form-field appearance="outline">
                <mat-label>Gender</mat-label>
                @if (mode() === 'view') {
                  <input matInput [value]="userForm().value().Gender ?? ''" readonly />
                } @else {
                  <mat-select [field]="userForm.Gender">
                    <mat-option [value]="null">None</mat-option>
                    @for (gender of genderOptions; track gender) {
                      <mat-option [value]="gender">{{ gender }}</mat-option>
                    }
                  </mat-select>
                }
              </mat-form-field>

              <!-- Language -->
              <mat-form-field appearance="outline">
                <mat-label>Language</mat-label>
                @if (mode() === 'view') {
                  <input matInput [value]="userForm().value().Language ?? ''" readonly />
                } @else {
                  <mat-select [field]="userForm.Language">
                    <mat-option [value]="null">None</mat-option>
                    @for (lang of languageOptions; track lang) {
                      <mat-option [value]="lang">{{ lang }}</mat-option>
                    }
                  </mat-select>
                }
              </mat-form-field>

              <!-- Date of Birth -->
              <mat-form-field appearance="outline">
                <mat-label>Date of Birth</mat-label>
                @if (mode() === 'view') {
                  <input matInput [value]="userForm().value().dateOfBirth | date" readonly />
                } @else {
                  <ng-container>
                    <input matInput [field]="userForm.dateOfBirth" [matDatepicker]="dobPicker" />
                    <mat-datepicker-toggle matSuffix [for]="dobPicker"></mat-datepicker-toggle>
                    <mat-datepicker #dobPicker></mat-datepicker>
                  </ng-container>
                }
              </mat-form-field>

              <!-- Photo URL -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Photo URL</mat-label>
                @if (mode() === 'view') {
                  <input
                    matInput
                    [value]="userForm().value().photoUrl"
                    readonly
                  />
                } @else {
                  <input
                    matInput
                    [field]="userForm.photoUrl"
                    placeholder="Enter photo URL"
                  />
                }
              </mat-form-field>

              <!-- Section: Professional Information -->
              <h3 class="section-title">Professional Information</h3>

              <!-- Position -->
              <mat-form-field appearance="outline">
                <mat-label>Position</mat-label>
                @if (mode() === 'view') {
                  <input matInput [value]="userForm().value().position ?? ''" readonly />
                } @else {
                  <mat-select [field]="userForm.position">
                    <mat-option [value]="null">None</mat-option>
                    @for (pos of positionOptions; track pos) {
                      <mat-option [value]="pos">{{ pos }}</mat-option>
                    }
                  </mat-select>
                }
              </mat-form-field>

              <!-- Job Title -->
              <mat-form-field appearance="outline">
                <mat-label>Job Title</mat-label>
                @if (mode() === 'view') {
                  <input
                    matInput
                    [value]="userForm().value().jobTitle"
                    readonly
                  />
                } @else {
                  <input
                    matInput
                    [field]="userForm.jobTitle"
                    placeholder="Enter job title"
                  />
                }
              </mat-form-field>

              <!-- Manager ID -->
              <mat-form-field appearance="outline">
                <mat-label>Manager ID</mat-label>
                @if (mode() === 'view') {
                  <input
                    matInput
                    [value]="userForm().value().managerId"
                    readonly
                  />
                } @else {
                  <input
                    matInput
                    [field]="userForm.managerId"
                    placeholder="Enter manager ID"
                  />
                }
              </mat-form-field>

              <!-- Section: Emergency Contact -->
              <h3 class="section-title">Emergency Contact</h3>

              <!-- Has Emergency Contact -->
              <div class="checkbox-field">
                @if (mode() === 'view') {
                  <mat-checkbox [checked]="userForm().value().hasEmergencyContact" disabled>
                    Has Emergency Contact
                  </mat-checkbox>
                } @else {
                  <mat-checkbox [field]="userForm.hasEmergencyContact">
                    Has Emergency Contact
                  </mat-checkbox>
                }
              </div>

              <!-- Emergency Contact Name -->
              <mat-form-field appearance="outline">
                <mat-label>Emergency Contact Name</mat-label>
                @if (mode() === 'view') {
                  <input
                    matInput
                    [value]="userForm().value().emergencyContactName"
                    readonly
                  />
                } @else {
                  <input
                    matInput
                    [field]="userForm.emergencyContactName"
                    placeholder="Enter emergency contact name"
                  />
                  <lib-field-error [fieldError]="userForm.emergencyContactName()" />
                }
              </mat-form-field>

              <!-- Emergency Contact Phone -->
              <mat-form-field appearance="outline">
                <mat-label>Emergency Contact Phone</mat-label>
                @if (mode() === 'view') {
                  <input
                    matInput
                    [value]="userForm().value().emergencyContactPhone"
                    readonly
                  />
                } @else {
                  <input
                    matInput
                    [field]="userForm.emergencyContactPhone"
                    placeholder="Enter emergency contact phone"
                  />
                  <lib-field-error [fieldError]="userForm.emergencyContactPhone()" />
                }
              </mat-form-field>

              <!-- Section: Account Status -->
              <h3 class="section-title">Account Status</h3>

              <!-- Published -->
              <div class="checkbox-field">
                @if (mode() === 'view') {
                  <mat-checkbox [checked]="userForm().value().published ?? false" disabled>
                    Published
                  </mat-checkbox>
                } @else {
                  <mat-checkbox [field]="userForm.published">
                    Published
                  </mat-checkbox>
                }
              </div>

              <!-- Is Public -->
              <div class="checkbox-field">
                @if (mode() === 'view') {
                  <mat-checkbox [checked]="userForm().value().isPublic ?? false" disabled>
                    Is Public
                  </mat-checkbox>
                } @else {
                  <mat-checkbox [field]="userForm.isPublic">
                    Is Public
                  </mat-checkbox>
                }
              </div>

              <!-- Is Validated -->
              <mat-form-field appearance="outline">
                <mat-label>Is Validated</mat-label>
                @if (mode() === 'view') {
                  <input matInput [value]="userForm().value().isValidated | date" readonly />
                } @else {
                  <ng-container>
                    <input matInput [field]="userForm.isValidated" [matDatepicker]="validatedPicker" />
                    <mat-datepicker-toggle matSuffix [for]="validatedPicker"></mat-datepicker-toggle>
                    <mat-datepicker #validatedPicker></mat-datepicker>
                  </ng-container>
                }
              </mat-form-field>

              <!-- Is Suspended -->
              <mat-form-field appearance="outline">
                <mat-label>Is Suspended</mat-label>
                @if (mode() === 'view') {
                  <input matInput [value]="userForm().value().isSuspended | date" readonly />
                } @else {
                  <ng-container>
                    <input matInput [field]="userForm.isSuspended" [matDatepicker]="suspendedPicker" />
                    <mat-datepicker-toggle matSuffix [for]="suspendedPicker"></mat-datepicker-toggle>
                    <mat-datepicker #suspendedPicker></mat-datepicker>
                  </ng-container>
                }
              </mat-form-field>
            </div>
          </form>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Bottom Toolbar with Commands -->
    <mat-toolbar class="bottom-toolbar">
      <!-- Admin Actions -->
      @if (isAdmin()) {
        <button
          mat-icon-button
          matTooltip="Permanent Delete"
          [disabled]="!isAdmin() || mode() === 'edit'"
          (click)="remove()"
          class="danger-btn"
        >
          <mat-icon>delete_forever</mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Virtual Delete"
          [disabled]="!isAdmin() || mode() === 'edit'"
          (click)="virtualRemove()"
          class="warning-btn"
        >
          <mat-icon>delete</mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Add record"
          [disabled]="!isAdmin()"
          (click)="add()"
          class="success-btn"
        >
          <mat-icon>add_circle</mat-icon>
        </button>
      }

      <mat-divider [vertical]="true"></mat-divider>

      <!-- Form Actions -->
      <button
        mat-icon-button
        matTooltip="Cancel"
        [disabled]="mode() === 'view'"
        (click)="cancel()"
      >
        <mat-icon>cancel</mat-icon>
      </button>
      <button
        mat-icon-button
        matTooltip="Save changes"
        [disabled]="mode() === 'view'"
        (click)="save()"
        class="success-btn"
      >
        <mat-icon>check_circle</mat-icon>
      </button>

      <mat-divider [vertical]="true"></mat-divider>

      <!-- Debug Navigation -->
      <span style="color: yellow; font-size: 0.8rem; margin: 0 0.5rem;">
        Nav: {{ selectedUsers().length }} users
      </span>

      <!-- Navigation Buttons -->
      @if (selectedUsers().length > 1) {
        <button
          mat-icon-button
          matTooltip="First record"
          [disabled]="isFirst()"
          (click)="first()"
        >
          <mat-icon>first_page</mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Previous record"
          [disabled]="!hasPrevious()"
          (click)="previous()"
        >
          <mat-icon>skip_previous</mat-icon>
        </button>
        <span class="navigation-indicator">
          {{ currentIndex() + 1 }} / {{ selectedUsers().length }}
        </span>
        <button
          mat-icon-button
          matTooltip="Next record"
          [disabled]="!hasNext()"
          (click)="next()"
        >
          <mat-icon>skip_next</mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Last record"
          [disabled]="isLast()"
          (click)="last()"
        >
          <mat-icon>last_page</mat-icon>
        </button>
      }

      <mat-divider [vertical]="true"></mat-divider>

      <!-- Utility Buttons -->
      <button mat-icon-button matTooltip="Reset" (click)="reload()">
        <mat-icon>autorenew</mat-icon>
      </button>
      <button mat-icon-button matTooltip="Back to list" (click)="goBack()">
        <mat-icon>exit_to_app</mat-icon>
      </button>
    </mat-toolbar>
  }
</div>
