<div class="container">
  <!-- Loading Spinner -->
  @if (isLoading()) {
    <div class="loading-spinner">
      <mat-spinner></mat-spinner>
    </div>
  }

  @if (!isLoading()) {

    <div class="header">
      <h1 class="mat-headline-4">{{ 'userProfile.title' | translate }}</h1>
      <p class="mat-body-1">
        {{ 'userProfile.profileSubtitle' | translate }}
      </p>
    </div>
        <!-- Toolbar Header -->
        <mat-toolbar color="primary">
          <button mat-icon-button (click)="goBack()" matTooltip="Back to list">
            <mat-icon>arrow_back</mat-icon>
          </button>
          <span class="toolbar-title">User Detail</span>
          <span class="spacer"></span>
          @if (selectedUsers().length > 0) {
            <span class="navigation-info">
              {{ currentIndex() + 1 }} / {{ selectedUsers().length }}
            </span>
          }
          @if (mode() === 'view') {
            <button mat-icon-button matTooltip="Edit" (click)="mode.set('edit')">
              <mat-icon>edit</mat-icon>
            </button>
          }
        </mat-toolbar>

    <!-- Main Content -->
    <div class="content">
      <mat-card class="form-card">
        <mat-card-header>
          <mat-card-title>
            @if (mode() === 'view') {
              {{ userForm().value().firstName }} {{ userForm().value().lastName }}
            } @else {
              Ajouter / Modifier un utilisateur
            }
          </mat-card-title>
        </mat-card-header>

        <mat-card-content>
          <form class="form-container">
            <mat-tab-group>
              <!-- Tab: Basic Information -->
              <mat-tab label="Informations de base">
                <div class="tab-content">
                  <div class="form-grid">
                    <!-- ID (readonly) -->
                    <mat-form-field appearance="outline">
                      <mat-label>ID</mat-label>
                      <input matInput [value]="userForm().value().id" readonly />
                    </mat-form-field>

                    <!-- Email -->
                    <mat-form-field appearance="outline">
                      <mat-label>Email</mat-label>
                      <input
                        matInput
                        [field]="userForm.email"
                        [readOnly]="mode() ? 'view' : 'edit'"
                        type="email"
                        placeholder="Enter email"
                      />
                      <mat-error>
                        <lib-field-error [fieldError]="userForm.email()" />
                      </mat-error>
                    </mat-form-field>

                    <!-- First Name -->
                    <mat-form-field appearance="outline">
                      <mat-label>First Name</mat-label>
                      <input
                        matInput
                        [field]="userForm.firstName"
                        [readOnly]="mode() ? 'view' : 'edit'"
                        placeholder="Enter first name"
                      />
                      <mat-error>
                        <lib-field-error [fieldError]="userForm.firstName()" />
                      </mat-error>
                    </mat-form-field>

                    <!-- Last Name -->
                    <mat-form-field appearance="outline">
                      <mat-label>Last Name</mat-label>
                      <input
                        matInput
                        [field]="userForm.lastName"
                        [readOnly]="mode() ? 'view' : 'edit'"
                        placeholder="Enter last name"
                      />
                      <mat-error>
                        <lib-field-error [fieldError]="userForm.lastName()" />
                      </mat-error>
                    </mat-form-field>

                    <!-- Title -->
                    <mat-form-field appearance="outline">
                      <mat-label>Title</mat-label>
                      @if (mode() === 'view') {
                        <input
                          matInput [value]="userForm().value().title ?? ''" readonly />
                      } @else {
                        <mat-select [field]="userForm.title">
                          <mat-option [value]="null">None</mat-option>
                          @for (title of titleOptions; track title) {
                            <mat-option [value]="title">{{ title }}</mat-option>
                          }
                        </mat-select>
                      }
                    </mat-form-field>

                    <!-- Nick Name -->
                    <mat-form-field appearance="outline">
                      <mat-label>Nick Name</mat-label>
                      <input
                        matInput
                        [field]="userForm.nickName"
                        [readOnly]="mode() ? 'view' : 'edit'"
                        placeholder="Enter nick name"
                      />
                      <mat-error>
                        <lib-field-error [fieldError]="userForm.nickName()" />
                      </mat-error>
                    </mat-form-field>

                    <!-- Gender -->
                    <mat-form-field appearance="outline">
                      <mat-label>Gender</mat-label>
                      @if (mode() === 'view') {
                        <input matInput [value]="userForm().value().Gender ?? ''" readonly />
                      } @else {
                        <mat-select [field]="userForm.Gender">
                          <mat-option [value]="null">None</mat-option>
                          @for (gender of genderOptions; track gender) {
                            <mat-option [value]="gender">{{ gender }}</mat-option>
                          }
                        </mat-select>
                      }
                    </mat-form-field>

                    <!-- Language -->
                    <mat-form-field appearance="outline">
                      <mat-label>Language</mat-label>
                      @if (mode() === 'view') {
                        <input matInput [value]="userForm().value().Language ?? ''" readonly />
                      } @else {
                        <mat-select [field]="userForm.Language">
                          <mat-option [value]="null">None</mat-option>
                          @for (lang of languageOptions; track lang) {
                            <mat-option [value]="lang">{{ lang }}</mat-option>
                          }
                        </mat-select>
                      }
                    </mat-form-field>

                    <!-- Date of Birth -->
                    <mat-form-field appearance="outline">
                      <mat-label>Date of Birth</mat-label>
                      <ng-container>
                        <input matInput
                          [field]="userForm.dateOfBirth"
                          [readOnly]="mode() ? 'view' : 'edit'"
                          [matDatepicker]="dobPicker" />
                        <mat-datepicker-toggle matSuffix [for]="dobPicker"></mat-datepicker-toggle>
                        <mat-datepicker #dobPicker></mat-datepicker>
                      </ng-container>
                    </mat-form-field>

                    <!-- Photo URL -->
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Photo URL</mat-label>
                      <input
                        matInput
                        [field]="userForm.photoUrl"
                        [readOnly]="mode() ? 'view' : 'edit'"
                        placeholder="Enter photo URL"
                      />
                      <mat-error>
                        <lib-field-error [fieldError]="userForm.photoUrl()" />
                      </mat-error>
                    </mat-form-field>
                  </div>
                </div>
              </mat-tab>

              <!-- Tab: Professional Information -->
              <mat-tab label="Informations professionnelles">
                <div class="tab-content">
                  <div class="form-grid">
                    <!-- Position -->
                    <mat-form-field appearance="outline">
                      <mat-label>Position</mat-label>
                      @if (mode() === 'view') {
                        <input matInput [value]="userForm().value().position ?? ''" readonly />
                      } @else {
                        <mat-select [field]="userForm.position">
                          <mat-option [value]="null">None</mat-option>
                          @for (pos of positionOptions; track pos) {
                            <mat-option [value]="pos">{{ pos }}</mat-option>
                          }
                        </mat-select>
                      }
                    </mat-form-field>

                    <!-- Job Title -->
                    <mat-form-field appearance="outline">
                      <mat-label>Job Title</mat-label>
                      <input
                        matInput
                        [field]="userForm.jobTitle"
                        [readOnly]="mode() ? 'view' : 'edit'"
                        placeholder="Enter job title"
                      />
                      <mat-error>
                        <lib-field-error [fieldError]="userForm.jobTitle()" />
                      </mat-error>
                    </mat-form-field>

                    <!-- Manager ID -->
                    <mat-form-field appearance="outline">
                      <mat-label>Manager ID</mat-label>
                      @if (mode() === 'view') {
                        <input
                          matInput
                          [value]="userForm().value().managerId"
                          readonly
                        />
                      } @else {
                        <input
                          matInput
                          [field]="userForm.managerId"
                          placeholder="Enter manager ID"
                        />
                      }
                    </mat-form-field>
                  </div>
                </div>
              </mat-tab>

              <!-- Tab: Emergency Contact -->
              <mat-tab label="Contact d'urgence">
                <div class="tab-content">
                  <div class="form-grid">
                    <!-- Has Emergency Contact -->
                    <div class="checkbox-field">
                      @if (mode() === 'view') {
                        <mat-checkbox [checked]="userForm().value().hasEmergencyContact" disabled>
                          Has Emergency Contact
                        </mat-checkbox>
                      } @else {
                        <mat-checkbox [field]="userForm.hasEmergencyContact">
                          Has Emergency Contact
                        </mat-checkbox>
                      }
                    </div>

                    <!-- Emergency Contact Name -->
                    <mat-form-field appearance="outline">
                      <mat-label>Emergency Contact Name</mat-label>
                      <input
                        matInput
                        [field]="userForm.emergencyContactName"
                        [readOnly]="mode() ? 'view' : 'edit'"
                        placeholder="Enter emergency contact name"
                      />
                      <mat-error>
                        <lib-field-error [fieldError]="userForm.emergencyContactName()" />
                      </mat-error>
                    </mat-form-field>

                    <!-- Emergency Contact Phone -->
                    <mat-form-field appearance="outline">
                      <mat-label>Emergency Contact Phone</mat-label>
                      <input
                        matInput
                        [field]="userForm.emergencyContactPhone"
                        [readOnly]="mode() ? 'view' : 'edit'"
                        placeholder="Enter emergency contact phone"
                      />
                      <mat-error>
                        <lib-field-error [fieldError]="userForm.emergencyContactPhone()" />
                      </mat-error>
                    </mat-form-field>
                  </div>
                </div>
              </mat-tab>

              <!-- Tab: Account Status -->
              <mat-tab label="Statut du compte">
                <div class="tab-content">
                  <div class="form-grid">
                    <!-- Published -->
                    <div class="checkbox-field">
                      @if (mode() === 'view') {
                        <mat-checkbox [checked]="userForm().value().published ?? false" disabled>
                          Published
                        </mat-checkbox>
                      } @else {
                        <mat-checkbox [field]="userForm.published">
                          Published
                        </mat-checkbox>
                      }
                    </div>

                    <!-- Is Public -->
                    <div class="checkbox-field">
                      @if (mode() === 'view') {
                        <mat-checkbox [checked]="userForm().value().isPublic ?? false" disabled>
                          Is Public
                        </mat-checkbox>
                      } @else {
                        <mat-checkbox [field]="userForm.isPublic">
                          Is Public
                        </mat-checkbox>
                      }
                    </div>

                    <!-- Is Validated -->
                    <mat-form-field appearance="outline">
                      <mat-label>Is Validated</mat-label>
                      <ng-container>
                        <input matInput
                          [field]="userForm.isValidated"
                          [readOnly]="mode() ? 'view' : 'edit'"
                          [matDatepicker]="validatedPicker" />
                        <mat-datepicker-toggle matSuffix [for]="validatedPicker"></mat-datepicker-toggle>
                        <mat-datepicker #validatedPicker></mat-datepicker>
                      </ng-container>
                    </mat-form-field>

                    <!-- Is Suspended -->
                    <mat-form-field appearance="outline">
                      <mat-label>Is Suspended</mat-label>
                      <ng-container>
                        <input matInput
                          [field]="userForm.isSuspended"
                          [readOnly]="mode() ? 'view' : 'edit'"
                          [matDatepicker]="suspendedPicker" />
                        <mat-datepicker-toggle matSuffix [for]="suspendedPicker"></mat-datepicker-toggle>
                        <mat-datepicker #suspendedPicker></mat-datepicker>
                      </ng-container>
                    </mat-form-field>
                  </div>
                </div>
              </mat-tab>
            </mat-tab-group>
          </form>
        </mat-card-content>
      </mat-card>

     <mat-divider [vertical]="true"></mat-divider>

    <!-- Bottom Toolbar with Commands -->
    <mat-toolbar class="bottom-toolbar">
      <!-- Admin Actions -->
      @if (isAdmin()) {
        <button
          mat-icon-button
          matTooltip="Permanent Delete"
          [disabled]="!isAdmin() || mode() === 'edit'"
          (click)="remove()"
          class="danger-btn"
        >
          <mat-icon>delete_forever</mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Virtual Delete"
          [disabled]="!isAdmin() || mode() === 'edit'"
          (click)="virtualRemove()"
          class="warning-btn"
        >
          <mat-icon>delete</mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Add record"
          [disabled]="!isAdmin()"
          (click)="add()"
          class="success-btn"
        >
          <mat-icon>add_circle</mat-icon>
        </button>
      }

      <mat-divider [vertical]="true"></mat-divider>

      <!-- Form Actions -->
      <button
        mat-icon-button
        matTooltip="Cancel"
        [disabled]="mode() === 'view'"
        (click)="cancel()"
      >
        <mat-icon>cancel</mat-icon>
      </button>
      <button
        mat-icon-button
        matTooltip="Save changes"
        [disabled]="mode() === 'view'"
        (click)="save()"
        class="success-btn"
      >
        <mat-icon>check_circle</mat-icon>
      </button>

      <mat-divider [vertical]="true"></mat-divider>

      <!-- Debug Navigation -->
      <!-- <span style="color: red; font-size: 0.8rem; margin: 0 0.5rem;">
        Nav: {{ selectedUsers().length }} users
      </span> -->

      <!-- Navigation Buttons -->
      @if (selectedUsers().length > 1) {
        <button
          mat-icon-button
          matTooltip="First record"
          [disabled]="isFirst()"
          (click)="first()"
        >
          <mat-icon>first_page</mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Previous record"
          [disabled]="!hasPrevious()"
          (click)="previous()"
        >
          <mat-icon>skip_previous</mat-icon>
        </button>
        <span class="navigation-indicator">
          {{ currentIndex() + 1 }} / {{ selectedUsers().length}}
        </span>
        <button
          mat-icon-button
          matTooltip="Next record"
          [disabled]="!hasNext()"
          (click)="next()"
        >
          <mat-icon>skip_next</mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Last record"
          [disabled]="isLast()"
          (click)="last()"
        >
          <mat-icon>last_page</mat-icon>
        </button>
      }

      <mat-divider [vertical]="true"></mat-divider>

      <!-- Utility Buttons -->
      <button mat-icon-button matTooltip="Reset" (click)="reload()">
        <mat-icon>autorenew</mat-icon>
      </button>
      <button mat-icon-button matTooltip="Back to list" (click)="goBack()">
        <mat-icon>exit_to_app</mat-icon>
      </button>
    </mat-toolbar>
    </div>
  }

</div>
