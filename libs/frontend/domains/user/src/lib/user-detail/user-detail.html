<div class="user-detail-container">
  <!-- Loading Spinner -->
  @if (isLoading()) {
    <div class="loading-spinner">
      <mat-spinner></mat-spinner>
    </div>
  }

  @if (!isLoading()) {
    <!-- Toolbar Header -->
    <mat-toolbar color="primary">
      <button mat-icon-button (click)="goBack()" matTooltip="Back to list">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <span class="toolbar-title">User Detail</span>
      <span class="spacer"></span>
      <!-- Debug: affichage du nombre d'utilisateurs sélectionnés -->
      <span class="debug-info" style="color: yellow; margin: 0 1rem;">
        DEBUG: selectedUsers: {{ selectedUsers().length }} | selectedIds: {{ userStore.selectedIds().length }} | entities: {{ Object.keys(userStore.usersEntities()).length }}
        <br />
        <span style="font-size: 0.7rem;">
          IDs: {{ userStore.selectedIds().slice(0, 1) | json }} | Keys: {{ Object.keys(userStore.usersEntities()).slice(0, 1) | json }}
        </span>
      </span>
      @if (selectedUsers().length > 0) {
        <span class="navigation-info">
          {{ currentIndex() + 1 }} / {{ selectedUsers().length }}
        </span>
      }
    </mat-toolbar>

    <!-- Main Content -->
    <div class="content">
      <mat-card class="form-card">
        <mat-card-header>
          <mat-card-title>
            @if (mode() === 'view') {
              {{ userForm.value.firstName }} {{ userForm.value.lastName }}
            } @else {
              Ajouter / Modifier un utilisateur
            }
          </mat-card-title>
        </mat-card-header>

        <mat-card-content>
          <form [formGroup]="userForm">
            <!-- ID (readonly) -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>ID</mat-label>
              <input matInput formControlName="id" readonly />
            </mat-form-field>

            <!-- First Name -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>First Name</mat-label>
              <input
                matInput
                formControlName="firstName"
                [readonly]="mode() === 'view'"
                placeholder="Enter first name"
              />
              @if (userForm.get('firstName')?.invalid && userForm.get('firstName')?.touched) {
                <mat-error>
                  @if (userForm.get('firstName')?.errors?.['required']) {
                    First name is required
                  }
                  @if (userForm.get('firstName')?.errors?.['maxlength']) {
                    First name must not exceed 100 characters
                  }
                </mat-error>
              }
            </mat-form-field>

            <!-- Last Name -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Last Name</mat-label>
              <input
                matInput
                formControlName="lastName"
                [readonly]="mode() === 'view'"
                placeholder="Enter last name"
              />
              @if (userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched) {
                <mat-error>
                  @if (userForm.get('lastName')?.errors?.['required']) {
                    Last name is required
                  }
                  @if (userForm.get('lastName')?.errors?.['maxlength']) {
                    Last name must not exceed 100 characters
                  }
                </mat-error>
              }
            </mat-form-field>

            <!-- Email -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Email</mat-label>
              <input
                matInput
                formControlName="email"
                [readonly]="mode() === 'view'"
                placeholder="Enter email"
              />
              @if (userForm.get('email')?.invalid && userForm.get('email')?.touched) {
                <mat-error>
                  @if (userForm.get('email')?.errors?.['required']) {
                    Email is required
                  }
                  @if (userForm.get('email')?.errors?.['email']) {
                    Please enter a valid email address
                  }
                </mat-error>
              }
            </mat-form-field>
          </form>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Bottom Toolbar with Commands -->
    <mat-toolbar class="bottom-toolbar">
      <!-- Admin Actions -->
      @if (isAdmin()) {
        <button
          mat-icon-button
          matTooltip="Permanent Delete"
          [disabled]="!isAdmin() || mode() === 'edit'"
          (click)="remove()"
          class="danger-btn"
        >
          <mat-icon>delete_forever</mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Virtual Delete"
          [disabled]="!isAdmin() || mode() === 'edit'"
          (click)="virtualRemove()"
          class="warning-btn"
        >
          <mat-icon>delete</mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Add record"
          [disabled]="!isAdmin()"
          (click)="add()"
          class="success-btn"
        >
          <mat-icon>add_circle</mat-icon>
        </button>
      }

      <mat-divider [vertical]="true"></mat-divider>

      <!-- Form Actions -->
      <button
        mat-icon-button
        matTooltip="Cancel"
        [disabled]="mode() === 'view'"
        (click)="cancel()"
      >
        <mat-icon>cancel</mat-icon>
      </button>
      <button
        mat-icon-button
        matTooltip="Save changes"
        [disabled]="mode() === 'view' || !userForm.valid"
        (click)="save()"
        class="success-btn"
      >
        <mat-icon>check_circle</mat-icon>
      </button>

      <mat-divider [vertical]="true"></mat-divider>

      <!-- Debug Navigation -->
      <span style="color: yellow; font-size: 0.8rem; margin: 0 0.5rem;">
        Nav: {{ selectedUsers().length }} users
      </span>

      <!-- Navigation Buttons -->
      @if (selectedUsers().length > 1) {
        <button
          mat-icon-button
          matTooltip="First record"
          [disabled]="isFirst()"
          (click)="first()"
        >
          <mat-icon>first_page</mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Previous record"
          [disabled]="!hasPrevious()"
          (click)="previous()"
        >
          <mat-icon>skip_previous</mat-icon>
        </button>
        <span class="navigation-indicator">
          {{ currentIndex() + 1 }} / {{ selectedUsers().length }}
        </span>
        <button
          mat-icon-button
          matTooltip="Next record"
          [disabled]="!hasNext()"
          (click)="next()"
        >
          <mat-icon>skip_next</mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Last record"
          [disabled]="isLast()"
          (click)="last()"
        >
          <mat-icon>last_page</mat-icon>
        </button>
      }

      <mat-divider [vertical]="true"></mat-divider>

      <!-- Utility Buttons -->
      <button mat-icon-button matTooltip="Reset" (click)="reload()">
        <mat-icon>autorenew</mat-icon>
      </button>
      <button mat-icon-button matTooltip="Back to list" (click)="goBack()">
        <mat-icon>exit_to_app</mat-icon>
      </button>
    </mat-toolbar>
  }
</div>
