<div class="container">

  <!-- Loading Spinner -->
  @if (this.store.isLoading()) {
    <div class="loading-spinner">
      <mat-spinner></mat-spinner>
    </div>
  }
<!-- When loaded -->
  @if (!this.store.isLoading()) {

    <div class="header">
      <h1 class="mat-headline-4">{{ 'userProfile.title' | translate }}</h1>
      <p class="mat-body-1">
        {{ 'userProfile.profileSubtitle' | translate }}
      </p>
      <br>
      <div class="user-id-muted">{{ userForm().value().id }}</div>
    </div>

    <!-- Main Content -->
    <div class="content">
      <mat-card class="form-card">
        <mat-card-content>
          <form class="form-container">
            <mat-tab-group [preserveContent]="true">
              <!-- Onglet Informations de base -->
              <mat-tab label="{{ 'userProfile.basicInfoSection' | translate }}">
                <section class="form-section">
                  <div class="tab-content">
                    <div>
                      <!-- Email Address -->
                      <mat-form-field appearance="outline">
                        <mat-label>{{ 'userProfile.emailLabel' | translate }}</mat-label>
                        <input matInput
                          [formField]="userForm.email"
                          type="email"
                          placeholder="{{'userProfile.emailPlaceholder' | translate}}" />
                        <mat-error>
                          <lib-field-error [fieldError]="userForm.email()" />
                        </mat-error>
                      </mat-form-field>
                    </div>
                    <br>
                    <div class="fields-row">

                      <!-- First Name -->
                      <mat-form-field appearance="outline">
                        <mat-label>{{ 'userProfile.firstNameLabel' | translate }}</mat-label>
                        <input
                          matInput
                          [formField]="userForm.firstName"
                          placeholder="{{ 'userProfile.firstNamePlaceholder' | translate }}"
                        />
                        <mat-error>
                          <lib-field-error [fieldError]="userForm.firstName()" />
                        </mat-error>
                      </mat-form-field>
                      <!-- Last Name -->
                      <mat-form-field appearance="outline">
                        <mat-label>{{ 'userProfile.lastNameLabel' | translate }}</mat-label>
                        <input
                          matInput
                          [formField]="userForm.lastName"
                          placeholder="{{ 'userProfile.lastNamePlaceholder' | translate }}"
                        />
                        <mat-error>
                          <lib-field-error [fieldError]="userForm.lastName()" />
                        </mat-error>
                      </mat-form-field>
                      <!-- Title -->
                    <mat-form-field appearance="outline">
                      <mat-label>{{ 'userProfile.titleLabel' | translate }}</mat-label>
                      @if (mode() === 'view') {
                        <input
                          matInput [value]="userForm().value().title ?? ''"
                          readonly
                          placeholder="{{'userProfile.titlePlaceholder' | translate}}"/>
                      } @else {
                        <mat-select [formField]="userForm.title">
                          <mat-option [value]="null">None</mat-option>
                          @for (title of titleOptions; track title) {
                            <mat-option [value]="title">{{ title }}</mat-option>
                          }
                        </mat-select>
                      }
                    </mat-form-field>
                    <!-- Nick Name -->
                    <mat-form-field appearance="outline">
                      <mat-label>{{'userProfile.nickNameLabel' | translate}}</mat-label>
                      <input
                        matInput
                        [formField]="userForm.nickName"
                        placeholder="{{'userProfile.nickNamePlaceholder' | translate}}"
                      />
                      <mat-error>
                        <lib-field-error [fieldError]="userForm.nickName()" />
                      </mat-error>
                    </mat-form-field>
                    <!-- Gender -->
                    <mat-form-field appearance="outline">
                        <mat-label>{{'userProfile.genderLabel' | translate}}</mat-label>
                        @if (mode() === 'view') {
                          <input matInput [value]="userForm().value().Gender ?? ''" readonly />
                        } @else {
                          <mat-select [formField]="userForm.Gender">
                            <mat-option [value]="null">None</mat-option>
                            @for (gender of genderOptions; track gender) {
                              <mat-option [value]="gender">{{ gender }}</mat-option>
                            }
                          </mat-select>
                        }
                      </mat-form-field>
                      <!-- Language -->
                      <mat-form-field appearance="outline">
                        <mat-label>{{'userProfile.languageLabel' | translate}}</mat-label>
                        @if (mode() === 'view') {
                          <input matInput [value]="userForm().value().Language ?? ''" readonly />
                        } @else {
                          <mat-select [formField]="userForm.Language">
                            <mat-option [value]="null">None</mat-option>
                            @for (lang of languageOptions; track lang) {
                              <mat-option [value]="lang">{{ lang }}</mat-option>
                            }
                          </mat-select>
                        }
                      </mat-form-field>
                    </div>
                  </div>
                </section>
              </mat-tab>

              <!-- Onglet Informations d'adresse  -->
              <!-- <mat-tab label="Addresse"> -->
              <mat-tab label="{{ 'userProfile.addressSection' | translate }}">

                <section class="form-section">
                    <div class="tab-content">

                      <!-- Liste des adresses -->
                      @if (userForm.addresses() && userForm.addresses.length > 0) {
                        @for (address of userForm.addresses; track address; let i = $index) {
                          <div class="address-card">
                            <h4>{{ 'userProfile.addressLabel' | translate }} {{ i + 1 }}</h4>
                            <lib-address-form [form]="address" />

                          </div>
                        }
                      } @else {
                        <p class="no-data">{{ 'userProfile.noAddresses' | translate }}</p>
                      }

                    </div>
                  </section>

              </mat-tab>

              <!-- Onglet Informations additionnelles -->
              <mat-tab label="{{ 'userProfile.additionalInfoSection' | translate }}">
                <section class="form-section">
                  <div class="tab-content">
                    <div class="fields-row">
                      <!-- Date of Birth -->
                      <mat-form-field appearance="outline">
                        <mat-label>{{'userProfile.dateOfBirthLabel' | translate}}</mat-label>
                        <ng-container>
                          <input matInput
                            [formField]="userForm.dateOfBirth"
                            [matDatepicker]="dobPicker" />
                          <mat-datepicker-toggle matSuffix [for]="dobPicker"></mat-datepicker-toggle>
                          <mat-datepicker #dobPicker></mat-datepicker>
                        </ng-container>
                        <mat-error>
                          <lib-field-error [fieldError]="userForm.dateOfBirth()" />
                        </mat-error>
                      </mat-form-field>
                      <!-- Photo URL -->
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>{{'userProfile.profilePictureLabel' | translate}}</mat-label>
                        <input
                          matInput
                          [formField]="userForm.photoUrl"
                          placeholder="{{'userProfile.profilePicturePlaceholder' | translate}}"
                        />
                      </mat-form-field>
                    </div>
                  </div>
                </section>
              </mat-tab>
              <!-- Tab: Professional Information -->
              <mat-tab label="{{ 'userProfile.professionnalInfoSection' | translate }}">
                <section class="form-section">
                  <div class="tab-content">
                    <div class="fields-row">
                      <!-- Position -->
                      <mat-form-field appearance="outline">
                        <mat-label>{{'userProfile.positionLabel' | translate}}</mat-label>
                        @if (mode() === 'view') {
                          <input matInput [value]="userForm().value().position ?? ''" readonly />
                        } @else {
                          <mat-select [formField]="userForm.position">
                            <mat-option [value]="null">None</mat-option>
                            @for (pos of positionOptions; track pos) {
                              <mat-option [value]="pos">{{ pos }}</mat-option>
                            }
                          </mat-select>
                        }
                      </mat-form-field>
                      <!-- Job Title -->
                      <mat-form-field appearance="outline">
                        <mat-label>{{'userProfile.jobTitleLabel' | translate}}</mat-label>
                        <input matInput [formField]="userForm.jobTitle" placeholder="{{'userProfile.jobTitlePlaceholder' | translate}}" />
                        <mat-error>
                          <lib-field-error [fieldError]="userForm.jobTitle()" />
                        </mat-error>
                      </mat-form-field>
                      <!-- Manager ID -->
                      <mat-form-field appearance="outline">
                        <mat-label>Manager ID</mat-label>
                        @if (mode() === 'view') {
                          <input
                            matInput
                            [value]="userForm().value().managerId"
                            readonly
                          />
                        } @else {
                          <input
                            matInput
                            [formField]="userForm.managerId"
                            placeholder="Enter manager ID"
                          />
                        }
                      </mat-form-field>

                    </div>
                  </div>
                </section>
              </mat-tab>

              <!-- Tab: Emergency Contact -->
              <mat-tab label="{{ 'userProfile.emergencyContactInfoSection' | translate }}">
                <section class="form-section">
                  <div class="tab-content">
                    <div class="fields-row">

                      <!-- Has Emergency Contact -->
                      <div class="checkbox-field">
                        @if (mode() === 'view') {
                          <mat-checkbox [checked]="userForm().value().emergencyContact.hasEmergencyContact" disabled>
                            {{'userProfile.emergencyContactExist' | translate}}
                          </mat-checkbox>
                        } @else {
                          <mat-checkbox [formField]="userForm.emergencyContact.hasEmergencyContact">
                            {{'userProfile.emergencyContactExist' | translate}}
                          </mat-checkbox>
                        }
                      </div>

                      <!-- Emergency Contact Name -->
                      <mat-form-field appearance="outline">
                        <mat-label>{{'userProfile.emergencyContactLabel' | translate}}</mat-label>
                        <input
                          matInput
                          [formField]="userForm.emergencyContact.emergencyContactName"
                          placeholder="{{'userProfile.emergencyContactPlaceholder' | translate}}"
                        />
                        <mat-error>
                          <lib-field-error [fieldError]="userForm.emergencyContact.emergencyContactName()" />
                        </mat-error>
                      </mat-form-field>

                      <!-- Emergency Contact Phone -->
                      <mat-form-field appearance="outline">
                        <mat-label>{{'userProfile.emergencyContactPhoneLabel' | translate}}</mat-label>
                        <input
                          matInput
                          [formField]="userForm.emergencyContact.emergencyContactPhone"
                          placeholder="{{'userProfile.emergencyContactPhonePlaceholder' | translate}}"
                        />
                        <mat-error>
                          <lib-field-error [fieldError]="userForm.emergencyContact.emergencyContactPhone()" />
                        </mat-error>
                      </mat-form-field>

                    </div>
                  </div>
                </section>
              </mat-tab>
              <!-- Tab: Account Status  -->
              <mat-tab label="{{ 'userProfile.accountStatusSection' | translate }}">
                <section class="form-section">
                  <div class="tab-content">
                    <div class="fields-row">

                    <!-- Is Public -->
                      <div class="checkbox-field">
                        @if (mode() === 'view') {
                          <mat-checkbox [checked]="userForm().value().isPublic ?? false" disabled>
                            {{'userProfile.isPublicLabel' | translate}}
                          </mat-checkbox>
                        } @else {
                          <mat-checkbox [formField]="userForm.isPublic">
                            {{'userProfile.isPublicLabel' | translate}}
                          </mat-checkbox>
                        }
                      </div>

                      <!-- Published -->
                      <div class="checkbox-field">
                        @if (mode() === 'view') {
                          <mat-checkbox [checked]="userForm().value().published ?? false" disabled>
                            {{'userProfile.isPublishedLabel' | translate}}
                          </mat-checkbox>
                        } @else {
                          <mat-checkbox [formField]="userForm.published">
                            {{'userProfile.isPublishedLabel' | translate}}
                          </mat-checkbox>
                        }
                      </div>

                      <!-- Is Validated -->
                      <mat-form-field appearance="outline">
                        <mat-label>{{'userProfile.isValidatedLabel' | translate}}</mat-label>
                        <ng-container>
                          <input matInput
                            [formField]="userForm.isValidated"
                            [matDatepicker]="validatedPicker"
                          />
                          <mat-datepicker-toggle matSuffix [for]="validatedPicker"></mat-datepicker-toggle>
                          <mat-datepicker #validatedPicker></mat-datepicker>
                        </ng-container>
                      </mat-form-field>



                      <!-- Account suspended -->
                      <mat-form-field appearance="outline">
                        <mat-label>{{'userProfile.isSuspendedLabel' | translate}}</mat-label>
                        <ng-container>
                          <input matInput [formField]="userForm.isSuspended" [readOnly]="mode() === 'view' || mode() === 'edit'" [matDatepicker]="suspendedPicker" />
                          <mat-datepicker-toggle matSuffix [for]="suspendedPicker"></mat-datepicker-toggle>
                          <mat-datepicker #suspendedPicker></mat-datepicker>
                        </ng-container>
                      </mat-form-field>
                    </div>
                  </div>
                </section>
              </mat-tab>
            </mat-tab-group>
          </form>
        </mat-card-content>
      </mat-card>
    </div> <!-- .content -->
    <mat-toolbar class="bottom-toolbar">
      <!-- Admin Actions -->
      @if (isAdmin()) {
        <button
          mat-icon-button
          matTooltip="Permanent Delete"
          [disabled]="!isAdmin() || mode() === 'edit'"
          (click)="remove()"
          class="danger-btn">
          <mat-icon>delete_forever</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Virtual Delete" [disabled]="!isAdmin() || mode() === 'edit'" (click)="virtualRemove()" class="warning-btn">
          <mat-icon>delete</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Add record" [disabled]="!isAdmin()" (click)="add()" class="success-btn">
          <mat-icon>add_circle</mat-icon>
        </button>
      }
      <mat-divider [vertical]="true"></mat-divider>
      <!-- Form Actions -->
      <button mat-icon-button matTooltip="Cancel" [disabled]="mode() === 'view'" (click)="cancel()">
        <mat-icon>cancel</mat-icon>
      </button>
      <button mat-icon-button matTooltip="Save changes" [disabled]="mode() === 'view'" (click)="save()" class="success-btn">
        <mat-icon>check_circle</mat-icon>
      </button>
      <button mat-icon-button matTooltip="Edit" [disabled]="mode() === 'edit'" (click)="mode.set('edit')">
        <mat-icon>edit</mat-icon>
      </button>
      <mat-divider [vertical]="true"></mat-divider>
      <!-- Selection Order Menu -->
      @if (this.store.selectedIds().length > 0) {
        <button mat-icon-button [matMenuTriggerFor]="orderMenu" matTooltip="Ordre de navigation">
          <mat-icon>sort</mat-icon>
        </button>
        <mat-menu #orderMenu="matMenu">
          <button mat-menu-item (click)="applySelectionOrder('selection')">
            <mat-icon>touch_app</mat-icon>
            <span>Ordre de s√©lection</span>
          </button>
          <button mat-menu-item (click)="applySelectionOrder('store')">
            <mat-icon>storage</mat-icon>
            <span>Ordre des enregistrements</span>
          </button>
          <button mat-menu-item (click)="applySelectionOrder('sort')" [disabled]="!hasActiveSort()">
            <mat-icon>sort_by_alpha</mat-icon>
            <span>Ordre du tri</span>
          </button>
        </mat-menu>
      }
      <mat-divider [vertical]="true"></mat-divider>
      <!-- Navigation Buttons -->
      @if (this.store.selectedIds().length > 1) {
        <button mat-icon-button matTooltip="First record" [disabled]="store.navigation().isFirst" (click)="first()">
          <mat-icon>first_page</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Previous record" [disabled]="!store.navigation().hasPrevious" (click)="previous()">
          <mat-icon>skip_previous</mat-icon>
        </button>
        <span class="navigation-indicator">
          {{ store.currentPosition() + 1 }} / {{ this.store.selectedIds().length}}
        </span>
        <button mat-icon-button matTooltip="Next record" [disabled]="!store.navigation().hasNext" (click)="next()">
          <mat-icon>skip_next</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Last record" [disabled]="store.navigation().isLast" (click)="last()">
          <mat-icon>last_page</mat-icon>
        </button>
      }
      <mat-divider [vertical]="true"></mat-divider>
      <!-- Utility Buttons -->
      <button mat-icon-button matTooltip="Reset" (click)="reload()">
        <mat-icon>autorenew</mat-icon>
      </button>
      <button mat-icon-button matTooltip="Back to list" (click)="goBack()">
        <mat-icon>exit_to_app</mat-icon>
      </button>
    </mat-toolbar>
  }
</div>
<div>
  <h3>Debug Form</h3>
 <lib-debug-panel [form]="userForm()" />
</div>
  <section class="relations">
  <h3>Debug: selectedItemId = {{ this.store.selectedItemId() }}</h3>
  <h3>Debug: followers = {{ this.store.selectedItem()?.Followers?.length| json }}</h3>
  <h3>Debug: hasFollowers = {{ this.store.hasFollowers() }}</h3>
  </section>
  <div>
    <h3>Debug Info</h3>
    <br>
    <span style="color: red; font-weight: bold;" >Mode: {{ mode() }} </span>
    <br>
    <span style="color: orange; font-weight: bold;">selectedIds Array: {{ store.selectedIds() | json }}</span>
    <br>
    <span style="color: blue; font-weight: bold;">effectiveSelectedIds Array: {{ store.effectiveSelectedIds() | json }}</span>
    <br>
    <span> {{store.users().length}} data length </span>
    <br>
    <span> Selected Entries {{store.selection().selected.entries() | json }} </span>
    <br>
    <span>Initial Selected ID: {{ store.selectedItemId() }} </span>
    <br>
    <span> Initial selected Item: {{ store.selectedItem() | json }} </span>

  </div>
