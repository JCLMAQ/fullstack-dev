<div class="image-gallery">
  <!-- Header avec actions globales -->
<div class="image-gallery-container bg-gray-50 dark:bg-gray-900 min-h-screen">
  <!-- Header avec actions globales -->
  @if (showActions()) {
    <div class="gallery-header bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4">
      <div class="flex flex-wrap justify-between items-center gap-4">
        <div class="flex items-center space-x-2">
          @if (selectionMode()) {
            <button
              (click)="selectAll()"
              class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              <mat-icon class="mr-1">select_all</mat-icon>
              {{ 'IMAGE_GALLERY.SELECT_ALL' | translate }}
            </button>
          }

          @if (selectionMode() && hasSelectedImages()) {
            <button
              (click)="deselectAll()"
              class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              <mat-icon class="mr-1">deselect</mat-icon>
              {{ 'IMAGE_GALLERY.DESELECT_ALL' | translate }}
            </button>
          }

          @if (selectionMode() && hasSelectedImages()) {
            <span class="text-sm text-gray-600 dark:text-gray-400">
              {{ getSelectedCount() }} {{ 'IMAGE_GALLERY.SELECTED' | translate }}
            </span>
          }
        </div>

        @if (selectionMode() && hasSelectedImages()) {
          <div class="flex items-center space-x-2">
            <button
              (click)="deleteSelected()"
              class="inline-flex items-center px-4 py-2 border border-transparent rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
            >
              <mat-icon class="mr-1">delete</mat-icon>
              {{ 'IMAGE_GALLERY.DELETE_SELECTED' | translate }}
            </button>

            <button
              (click)="downloadSelected()"
              class="inline-flex items-center px-4 py-2 border border-transparent rounded-md text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
            >
              <mat-icon class="mr-1">download</mat-icon>
              {{ 'IMAGE_GALLERY.DOWNLOAD_SELECTED' | translate }}
            </button>
          </div>
        }
      </div>
    </div>
  }  <!-- Chargement -->
  @if (loading()) {
    <div class="flex flex-col items-center justify-center py-12">
      <mat-progress-spinner diameter="50" class="mb-4"></mat-progress-spinner>
      <p class="text-gray-600 dark:text-gray-400">{{ 'IMAGE_GALLERY.LOADING' | translate }}</p>
    </div>
  }

  <!-- Galerie d'images -->
  @if (!loading() && imagesSignal().length > 0) {
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 p-6">
      @for (image of imagesSignal(); track image.id) {
        <div
          [class.ring-2]="isSelected(image.id)"
          [class.ring-blue-500]="isSelected(image.id)"
          class="relative bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200 cursor-pointer overflow-hidden"
          (click)="onImageClick(image)"
          (keyup.enter)="onImageClick(image)"
          (keyup.space)="onImageClick(image)"
          tabindex="0"
          [attr.aria-label]="'Select image: ' + image.originalName"
        >
      <!-- Checkbox de sélection -->
      @if (selectionMode()) {
        <div class="absolute top-2 left-2 z-10">
          <div class="bg-white dark:bg-gray-700 rounded-full p-1 shadow-md">
            <mat-icon [class]="isSelected(image.id) ? 'text-blue-600 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'">
              {{ isSelected(image.id) ? 'check_circle' : 'radio_button_unchecked' }}
            </mat-icon>
          </div>
        </div>
      }

      <!-- Image -->
      <div class="aspect-square">
        <img
          [src]="getImageUrl(image)"
          [alt]="image.altText || image.originalName"
          class="w-full h-full object-cover"
          (error)="onImageError($event)"
          loading="lazy"
        />

        <!-- Overlay avec actions -->
        <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-50 transition-all duration-200 flex items-center justify-center opacity-0 hover:opacity-100">
          <div class="flex gap-2">
            <button
              type="button"
              (click)="viewImage(image, $event)"
              class="p-2 bg-white dark:bg-gray-700 rounded-full shadow-md hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors duration-200"
              [attr.aria-label]="'IMAGE_GALLERY.VIEW' | translate"
            >
              <mat-icon class="text-gray-700 dark:text-gray-300">visibility</mat-icon>
            </button>

            <button
              type="button"
              [matMenuTriggerFor]="imageMenu"
              (click)="$event.stopPropagation()"
              class="p-2 bg-white dark:bg-gray-700 rounded-full shadow-md hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors duration-200"
              [attr.aria-label]="'IMAGE_GALLERY.MORE_ACTIONS' | translate"
            >
              <mat-icon class="text-gray-700 dark:text-gray-300">more_vert</mat-icon>
            </button>

            <!-- Menu d'actions -->
            <mat-menu #imageMenu="matMenu">
              <button
                mat-menu-item
                (click)="toggleCarouselTag(image, $event)"
                [class]="hasCarouselTag(image) ? 'text-purple-600' : ''"
              >
                <mat-icon [class]="hasCarouselTag(image) ? 'text-purple-600' : ''">
                  {{ hasCarouselTag(image) ? 'check_circle' : 'add_circle' }}
                </mat-icon>
                <span>{{ hasCarouselTag(image) ? 'Retirer du carousel' : 'Ajouter au carousel' }}</span>
              </button>
              <button mat-menu-item (click)="openTagEditor(image, $event)">
                <mat-icon>label</mat-icon>
                <span>Gérer les tags</span>
              </button>
              <button
                mat-menu-item
                (click)="togglePublicStatus(image, $event)"
                [class]="image.isPublic ? 'text-green-600' : 'text-gray-600'"
              >
                <mat-icon [class]="image.isPublic ? 'text-green-600' : 'text-gray-600'">
                  {{ image.isPublic ? 'public' : 'lock' }}
                </mat-icon>
                <span>{{ image.isPublic ? 'Rendre privée' : 'Rendre publique' }}</span>
              </button>
              <mat-divider></mat-divider>
              <button mat-menu-item (click)="editImage()">
                <mat-icon>edit</mat-icon>
                <span>{{ 'IMAGE_GALLERY.EDIT' | translate }}</span>
              </button>
              <button mat-menu-item (click)="downloadImage(image)">
                <mat-icon>download</mat-icon>
                <span>{{ 'IMAGE_GALLERY.DOWNLOAD' | translate }}</span>
              </button>
              <button mat-menu-item (click)="copyImageUrl(image)">
                <mat-icon>link</mat-icon>
                <span>{{ 'IMAGE_GALLERY.COPY_URL' | translate }}</span>
              </button>
              <mat-divider></mat-divider>
              <button mat-menu-item (click)="deleteImage(image)" class="text-red-600">
                <mat-icon class="text-red-600">delete</mat-icon>
                <span>{{ 'IMAGE_GALLERY.DELETE' | translate }}</span>
              </button>
            </mat-menu>
          </div>
        </div>
      </div>

      <!-- Informations de l'image -->
      <div class="p-4">
        <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate mb-1">
          {{ image.originalName }}
        </h3>
        <div class="flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
          <span>{{ formatFileSize(image.fileSize) }}</span>
          @if (image.width && image.height) {
            <span>
              {{ image.width }}×{{ image.height }}
            </span>
          }
        </div>

        <!-- Tags -->
        <div class="mt-2">
          <div class="flex flex-wrap gap-1 items-center">
            @if (image.tags && image.tags.length > 0) {
              @for (tag of image.tags.slice(0, 2); track $index) {
                <span
                  [class]="tag === 'carousel' ? 'bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200' : 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200'"
                  class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                >
                  {{ tag }}
                </span>
              }
              @if (image.tags.length > 2) {
                <span
                  class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                >
                  +{{ image.tags.length - 2 }}
                </span>
              }
            }
          </div>
        </div>

        <!-- Statut de publication -->
        <div class="mt-2 flex justify-end">
          <mat-icon
            [class]="image.isPublic ? 'text-green-600 dark:text-green-400' : 'text-gray-400 dark:text-gray-500'"
            [matTooltip]="image.isPublic ? ('IMAGE_GALLERY.PUBLIC' | translate) : ('IMAGE_GALLERY.PRIVATE' | translate)"
            class="text-sm"
          >
            {{ image.isPublic ? 'public' : 'lock' }}
          </mat-icon>
        </div>
      </div>
        </div>
      }
    </div>
  }

  <!-- Message si aucune image -->
  @if (!loading() && imagesSignal().length === 0) {
    <div class="text-center py-12">
      <mat-icon class="text-6xl text-gray-400 dark:text-gray-500 mb-4">image</mat-icon>
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">
        {{ 'IMAGE_GALLERY.NO_IMAGES' | translate }}
      </h3>
      <p class="text-gray-600 dark:text-gray-400">
        {{ 'IMAGE_GALLERY.NO_IMAGES_DESCRIPTION' | translate }}
      </p>
    </div>
  }
</div>
